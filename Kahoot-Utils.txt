// ==UserScript==
// @name         Kahoot Utils
// @namespace    http://tampermonkey.net/
// @version      0.1
// @description  Helps you study questions in kahoot.
// @author       DanSavageGames
// @match        https://kahoot.it/*
// @icon         https://www.google.com/s2/favicons?sz=64&domain=kahoot.it
// @grant        none
// @require      https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.0/FileSaver.min.js
// ==/UserScript==

(function() {
    'use strict';

    // Credits
    var credits = ["https://github.com/Yuvix25/kahoot-answer-bot/tree/main/js", "https://greasyfork.org/en/scripts/425312-kaboot-modified"];

    // Keycode Variables
    const keyMap = {
        38: 1, // Top Left
        39: 2, // Top Right
        40: 3, // Bottom Left
        41: 4  // Bottom Right
    };

    // Key Answer Triggers
    document.addEventListener('keydown', e => {
        if (e.isComposing) return;
        const keyCode = e.keyCode;
        if (keyMap.hasOwnProperty(keyCode)) {
            clickAnswer(keyMap[keyCode]);
        }
    });

    // Click the answer element
    function clickAnswer(answerIndex) {
        const answerElement = document.querySelector(`[data-functional-selector="answer-${answerIndex}"]`);
        if (answerElement) {
            answerElement.click();
            logAnswer(answerElement.innerText, getCorrectAnswer());
        }
    }

    // Get the correct answer
    function getCorrectAnswer() {
        const correctElement = document.querySelector('[data-correct]');
        return correctElement ? correctElement.innerText : null;
    }

    // Log the answer
    function logAnswer(yourAnswer, correctAnswer) {
        const questionElement = document.querySelector('h1');
        const question = questionElement ? questionElement.innerText : null;

        if (question && yourAnswer && correctAnswer) {
            const isCorrect = yourAnswer === correctAnswer;
            saveToFile([question, yourAnswer, correctAnswer, isCorrect]);
            notify(isCorrect);
        }
    }

    // Notify the user
    function notify(isCorrect) {
        const message = isCorrect ? "Correct! :checkmark:" : "Incorrect! :redX:";
        Toastify({
            text: message,
            duration: 3000,
            close: true,
            gravity: 'top',
            position: 'right',
            stopOnFocus: true,
            style: {
                background: isCorrect ? "green" : "red"
            }
        }).showToast();
    }

    // Save to file
    function saveToFile(data) {
        const blob = new Blob([data.join('\t') + '\n'], {type: 'text/plain;charset=utf-8'});
        saveAs(blob, `KahootQuestions-${new Date().toLocaleDateString()}.txt`);
    }

    // Load Toastify
    function loadToastify() {
        return new Promise((resolve, reject) => {
            if (typeof Toastify !== 'undefined') {
                resolve(Toastify);
            } else {
                const script = document.createElement('script');
                script.src = 'https://cdn.jsdelivr.net/npm/toastify-js';
                script.onload = () => resolve(Toastify);
                script.onerror = () => reject(new Error('Failed to load Toastify'));
                document.head.appendChild(script);
            }
        });
    }

    // Initialize
    (async function() {
        await loadToastify();
    })();
})();
